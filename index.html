<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/n5ro/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>
    <style>
      .loading-text {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 24px;
        z-index: 999;
        display: none;
      }
    </style>
  </head>
  <body>
    <!-- å¯åŠ¨ç•Œé¢ -->
    <div id="startScreen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); display: flex; justify-content: center; align-items: center; z-index: 1000; font-family: Arial, sans-serif;">
      <div style="text-align: center; color: white;">
        <h1 style="font-size: 3em; margin-bottom: 20px; text-shadow: 0 0 20px rgba(255,215,0,0.5); background: linear-gradient(45deg, #ffd700, #ffed4e); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">âœ¨ åƒä½›æ´æ—¶å…‰ä¹‹é—¨ âœ¨</h1>
        <p style="font-size: 1.3em; margin-bottom: 10px; opacity: 0.9;">ç©¿è¶Šåƒå¹´ï¼Œè§è¯çŸ³çªŸé‡ç”Ÿ</p>
        <p style="font-size: 1em; margin-bottom: 30px; opacity: 0.7;">ä½“éªŒç¥ç§˜çš„ARå¤åŸä¹‹æ—…</p>
        <button id="startButton" style="
          background: linear-gradient(45deg, #ffd700, #ff6b6b); 
          color: white; 
          border: none; 
          padding: 18px 40px; 
          font-size: 1.3em; 
          font-weight: bold;
          border-radius: 30px; 
          cursor: pointer; 
          box-shadow: 0 5px 20px rgba(255,215,0,0.4);
          transition: all 0.3s;
          text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        " onmouseover="this.style.transform='scale(1.05) translateY(-2px)'; this.style.boxShadow='0 7px 25px rgba(255,215,0,0.6)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 5px 20px rgba(255,215,0,0.4)'">
          ğŸ¯ å¼€å¯æ—¶å…‰ä¹‹é—¨
        </button>
        <p style="font-size: 0.9em; margin-top: 20px; opacity: 0.6;">è¯·ç¡®ä¿æ‚¨å·²å…è®¸æ‘„åƒå¤´æƒé™</p>
      </div>
    </div>

    <div class="loading-text">æ­£åœ¨åŠ è½½åœºæ™¯...</div>

    <a-scene mindar-image="imageTargetSrc: ./qianfo.mind" 
             color-space="sRGB" 
             renderer="colorManagement: true, physicallyCorrectLights" 
             vr-mode-ui="enabled: false" 
             device-orientation-permission-ui="enabled: false"
             loading-screen="enabled: false">
      
      <a-assets>
        <!-- çŸ³çªŸ3Dæ¨¡å‹ -->
        <a-asset-item id="caveModel" src="./buddhist.glb"></a-asset-item>
        
        <!-- ç¥¥äº‘æ¨¡å‹ï¼ˆå¦‚æœæœ‰ï¼‰ -->
        <a-asset-item id="cloudModel" src="./cloud.glb"></a-asset-item>
        
        <!-- é¾™æ¨¡å‹ï¼ˆå¦‚æœæœ‰ï¼‰ -->
        <a-asset-item id="dragonModel" src="./dragon.glb"></a-asset-item>
        
        <!-- éŸ³æ•ˆèµ„æº -->
        <audio id="chantAudio" src="./chant.mp3" preload="auto"></audio>
        <audio id="magicSound" src="./magic.mp3" preload="auto"></audio>
        <audio id="bellSound" src="./bell.mp3" preload="auto"></audio>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
      
      <a-entity mindar-image-target="targetIndex: 0">
        <!-- ä¸»çŸ³çªŸæ¨¡å‹ - åˆå§‹çŠ¶æ€åŠé€æ˜ -->
        <a-gltf-model 
          id="mainCave"
          rotation="0 0 0" 
          position="0 0 0" 
          scale="0.3 0.3 0.3" 
          src="#caveModel"
          opacity="0"
          animation-mixer="clip: *; loop: repeat"
          animation__fadein="property: opacity; from: 0; to: 1; dur: 3000; delay: 500; easing: easeInOutQuad"
          animation__scale="property: scale; from: 0.1 0.1 0.1; to: 0.3 0.3 0.3; dur: 2000; easing: easeOutElastic">
        </a-gltf-model>
        
        <!-- èƒ½é‡æŸ±å…‰æ•ˆ -->
        <a-cylinder
          id="energyPillar"
          position="0 1 0"
          radius="0.8"
          height="3"
          opacity="0.3"
          color="#ffd700"
          animation__rotate="property: rotation; to: 0 360 0; dur: 4000; loop: true; easing: linear"
          animation__pulse="property: scale; from: 1 1 1; to: 1.1 1.2 1.1; dur: 1500; dir: alternate; loop: true">
          <a-cylinder
            position="0 0 0"
            radius="0.6"
            height="3"
            opacity="0.2"
            color="#ffffff"
            animation__rotate="property: rotation; to: 0 -360 0; dur: 3000; loop: true; easing: linear">
          </a-cylinder>
        </a-cylinder>
        
        <!-- ç²’å­å…‰ç¯ç³»ç»Ÿ -->
        <a-entity id="particleRing" position="0 0.5 0">
          <!-- ä½¿ç”¨å¤šä¸ªå°çƒä½“æ¨¡æ‹Ÿç²’å­ -->
          <a-sphere 
            position="0.5 0 0" 
            radius="0.02" 
            color="#ffd700" 
            opacity="0.8"
            animation__orbit="property: rotation; to: 0 360 0; dur: 3000; loop: true; easing: linear">
          </a-sphere>
          <a-sphere 
            position="-0.5 0 0" 
            radius="0.02" 
            color="#ffd700" 
            opacity="0.8"
            animation__orbit="property: rotation; to: 0 360 0; dur: 3000; loop: true; easing: linear">
          </a-sphere>
          <a-sphere 
            position="0 0 0.5" 
            radius="0.02" 
            color="#ffd700" 
            opacity="0.8"
            animation__orbit="property: rotation; to: 0 360 0; dur: 3000; loop: true; easing: linear">
          </a-sphere>
          <a-sphere 
            position="0 0 -0.5" 
            radius="0.02" 
            color="#ffd700" 
            opacity="0.8"
            animation__orbit="property: rotation; to: 0 360 0; dur: 3000; loop: true; easing: linear">
          </a-sphere>
        </a-entity>
        
        <!-- åœ°é¢å…‰ç¯ -->
        <a-ring 
          id="groundRing1"
          position="0 0.01 0" 
          rotation="-90 0 0" 
          radius-inner="0.3" 
          radius-outer="0.6" 
          color="#ffd700" 
          opacity="0"
          animation__fadein="property: opacity; from: 0; to: 0.5; dur: 1000; delay: 0"
          animation__scale="property: scale; from: 0.5 0.5 0.5; to: 1.5 1.5 1.5; dur: 2000; easing: easeOutQuad">
        </a-ring>
        
        <a-ring 
          id="groundRing2"
          position="0 0.02 0" 
          rotation="-90 0 0" 
          radius-inner="0.6" 
          radius-outer="0.9" 
          color="#ff6b6b" 
          opacity="0"
          animation__fadein="property: opacity; from: 0; to: 0.3; dur: 1000; delay: 500"
          animation__scale="property: scale; from: 0.5 0.5 0.5; to: 2 2 2; dur: 2500; easing: easeOutQuad">
        </a-ring>
        
        <!-- æµ®åŠ¨çš„å…‰ç‚¹ -->
        <a-entity id="floatingLights">
          <a-sphere
            position="0.3 0.5 0.3"
            radius="0.03"
            color="#ffffff"
            opacity="0.8"
            animation__float="property: position; to: 0.3 1.5 0.3; dur: 3000; dir: alternate; loop: true; easing: easeInOutSine"
            animation__pulse="property: scale; from: 1 1 1; to: 1.5 1.5 1.5; dur: 1500; dir: alternate; loop: true">
          </a-sphere>
          <a-sphere
            position="-0.3 0.7 -0.3"
            radius="0.03"
            color="#ffd700"
            opacity="0.8"
            animation__float="property: position; to: -0.3 1.7 -0.3; dur: 3500; dir: alternate; loop: true; easing: easeInOutSine"
            animation__pulse="property: scale; from: 1 1 1; to: 1.5 1.5 1.5; dur: 1700; dir: alternate; loop: true">
          </a-sphere>
          <a-sphere
            position="0.3 0.6 -0.3"
            radius="0.03"
            color="#87ceeb"
            opacity="0.8"
            animation__float="property: position; to: 0.3 1.6 -0.3; dur: 4000; dir: alternate; loop: true; easing: easeInOutSine"
            animation__pulse="property: scale; from: 1 1 1; to: 1.5 1.5 1.5; dur: 2000; dir: alternate; loop: true">
          </a-sphere>
        </a-entity>
        
        <!-- ç¥¥äº‘æ•ˆæœï¼ˆå¦‚æœæœ‰GLBï¼‰ -->
        <a-gltf-model 
          id="clouds"
          src="#cloudModel" 
          position="0 0.5 0" 
          scale="0.5 0.5 0.5"
          opacity="0.7"
          animation-mixer
          animation__rotate="property: rotation; to: 0 360 0; dur: 20000; loop: true; easing: linear">
        </a-gltf-model>
        
        <!-- é¾™çš„é£èˆæ•ˆæœï¼ˆå¦‚æœæœ‰GLBï¼‰ -->
        <a-gltf-model 
          id="dragon"
          src="#dragonModel" 
          position="1 1 0" 
          scale="0.2 0.2 0.2"
          opacity="0"
          animation-mixer
          animation__fly="property: position; to: -1 1 0; dur: 5000; dir: alternate; loop: true; easing: easeInOutQuad"
          animation__fadein="property: opacity; from: 0; to: 1; dur: 2000; delay: 3000">
        </a-gltf-model>
        
        <!-- å…‰æ•ˆç³»ç»Ÿ -->
        <a-light type="point" position="0 2 0" color="#ffd700" intensity="0" 
                 animation__intensity="property: intensity; from: 0; to: 2; dur: 2000; delay: 1000">
        </a-light>
        <a-light type="ambient" color="#404040" intensity="0.4"></a-light>
        
        <!-- èšå…‰ç¯æ•ˆæœ -->
        <a-light type="spot" position="0 3 0" rotation="-90 0 0" 
                 color="#ffffff" intensity="0" angle="30" penumbra="0.5"
                 animation__intensity="property: intensity; from: 0; to: 1.5; dur: 3000; delay: 2000">
        </a-light>
      </a-entity>
      
    </a-scene>

    <script>
      // Three.jsæ‰©å±•åŠŸèƒ½
      AFRAME.registerComponent('particle-system', {
        init: function () {
          const el = this.el;
          const scene = el.sceneEl.object3D;
          
          // åˆ›å»ºç²’å­ç³»ç»Ÿ
          const particleCount = 100;
          const particles = new THREE.BufferGeometry();
          const positions = new Float32Array(particleCount * 3);
          const colors = new Float32Array(particleCount * 3);
          
          for (let i = 0; i < particleCount; i++) {
            positions[i * 3] = (Math.random() - 0.5) * 2;
            positions[i * 3 + 1] = Math.random() * 2;
            positions[i * 3 + 2] = (Math.random() - 0.5) * 2;
            
            colors[i * 3] = 1;
            colors[i * 3 + 1] = 0.84;
            colors[i * 3 + 2] = 0;
          }
          
          particles.setAttribute('position', new THREE.BufferAttribute(positions, 3));
          particles.setAttribute('color', new THREE.BufferAttribute(colors, 3));
          
          const material = new THREE.PointsMaterial({
            size: 0.05,
            vertexColors: true,
            transparent: true,
            opacity: 0.8,
            blending: THREE.AdditiveBlending
          });
          
          this.particleSystem = new THREE.Points(particles, material);
          el.object3D.add(this.particleSystem);
        },
        
        tick: function (time) {
          if (this.particleSystem) {
            this.particleSystem.rotation.y = time * 0.0001;
            const positions = this.particleSystem.geometry.attributes.position.array;
            
            for (let i = 0; i < positions.length; i += 3) {
              positions[i + 1] += Math.sin(time * 0.001 + i) * 0.001;
            }
            
            this.particleSystem.geometry.attributes.position.needsUpdate = true;
          }
        }
      });

      // æè´¨æ¸å˜ç»„ä»¶
      AFRAME.registerComponent('material-transition', {
        schema: {
          duration: {default: 3000},
          from: {default: '#888888'},
          to: {default: '#ffd700'}
        },
        
        init: function () {
          this.startTime = Date.now();
          this.material = this.el.getObject3D('mesh').material;
        },
        
        tick: function () {
          const elapsed = Date.now() - this.startTime;
          const progress = Math.min(elapsed / this.data.duration, 1);
          
          if (this.material && progress < 1) {
            // æ¸å˜æ•ˆæœ
            this.material.emissive = new THREE.Color().lerpColors(
              new THREE.Color(this.data.from),
              new THREE.Color(this.data.to),
              progress
            );
            this.material.emissiveIntensity = progress * 0.5;
          }
        }
      });

      document.addEventListener('DOMContentLoaded', function() {
        const startScreen = document.getElementById('startScreen');
        const startButton = document.getElementById('startButton');
        const scene = document.querySelector('a-scene');
        const loadingText = document.querySelector('.loading-text');
        
        // éŸ³é¢‘è®¾ç½®
        const chantAudio = document.querySelector('#chantAudio');
        const magicSound = document.querySelector('#magicSound');
        const bellSound = document.querySelector('#bellSound');
        
        if (chantAudio) chantAudio.loop = true;
        if (chantAudio) chantAudio.volume = 0.6;
        if (magicSound) magicSound.volume = 0.8;
        if (bellSound) bellSound.volume = 0.7;
        
        // åˆå§‹éšè—åœºæ™¯
        scene.style.display = 'none';
        
        // å¯åŠ¨æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        startButton.addEventListener('click', async function() {
          try {
            startScreen.style.display = 'none';
            loadingText.style.display = 'block';
            scene.style.display = 'block';
            
            await new Promise(resolve => {
              if (scene.hasLoaded) {
                resolve();
              } else {
                scene.addEventListener('loaded', resolve);
              }
            });
            
            loadingText.style.display = 'none';
            console.log('ARçŸ³çªŸå¤åŸåœºæ™¯å·²å¯åŠ¨');
            
            // å¯åŠ¨åœºæ™¯
            setupScene();
            
          } catch (error) {
            console.error('å¯åŠ¨ARå¤±è´¥:', error);
            alert('å¯åŠ¨ARå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‘„åƒå¤´æƒé™å¹¶åˆ·æ–°é¡µé¢é‡è¯•');
            startScreen.style.display = 'flex';
            scene.style.display = 'none';
          }
        });
        
        // è®¾ç½®åœºæ™¯
        function setupScene() {
          const targetEntity = document.querySelector('[mindar-image-target]');
          const mainCave = document.querySelector('#mainCave');
          
          // æ·»åŠ ç²’å­ç³»ç»Ÿ
          targetEntity.setAttribute('particle-system', '');
          
          if (targetEntity) {
            // ç›®æ ‡æ£€æµ‹äº‹ä»¶
            targetEntity.addEventListener('targetFound', function() {
              console.log('å‘ç°åƒä½›æ´æ ‡è®° - å¼€å§‹å¤åŸåŠ¨ç”»');
              
              // æ’­æ”¾é­”æ³•éŸ³æ•ˆ
              if (magicSound) {
                magicSound.currentTime = 0;
                magicSound.play().catch(e => console.log('é­”æ³•éŸ³æ•ˆæ’­æ”¾å¤±è´¥:', e));
              }
              
              // å»¶è¿Ÿæ’­æ”¾é’Ÿå£°
              setTimeout(() => {
                if (bellSound) {
                  bellSound.play().catch(e => console.log('é’Ÿå£°æ’­æ”¾å¤±è´¥:', e));
                }
              }, 1500);
              
              // å»¶è¿Ÿæ’­æ”¾æ¢µéŸ³
              setTimeout(() => {
                if (chantAudio) {
                  chantAudio.play().catch(e => console.log('æ¢µéŸ³æ’­æ”¾å¤±è´¥:', e));
                }
              }, 3000);
              
              // è§¦å‘å¤åŸåŠ¨ç”»åºåˆ—
              startRestorationSequence();
            });
            
            targetEntity.addEventListener('targetLost', function() {
              console.log('ç›®æ ‡ä¸¢å¤± - æš‚åœéŸ³æ•ˆ');
              
              if (chantAudio) chantAudio.pause();
              if (magicSound) magicSound.pause();
            });
          }
        }
        
        // å¤åŸåŠ¨ç”»åºåˆ—
        function startRestorationSequence() {
          const mainCave = document.querySelector('#mainCave');
          
          // é˜¶æ®µ1: èƒ½é‡èšé›† (0-2ç§’)
          console.log('é˜¶æ®µ1: èƒ½é‡èšé›†');
          
          // é˜¶æ®µ2: çŸ³çªŸæ˜¾ç° (2-4ç§’)
          setTimeout(() => {
            console.log('é˜¶æ®µ2: çŸ³çªŸæ˜¾ç°');
            if (mainCave) {
              mainCave.setAttribute('material-transition', 'duration: 3000; from: #666666; to: #ffd700');
            }
          }, 2000);
          
          // é˜¶æ®µ3: è‰²å½©å¤åŸ (4-7ç§’)
          setTimeout(() => {
            console.log('é˜¶æ®µ3: è‰²å½©å¤åŸ');
            // è¿™é‡Œå¯ä»¥åˆ‡æ¢æè´¨æˆ–æ”¹å˜é¢œè‰²
          }, 4000);
          
          // é˜¶æ®µ4: å®Œå…¨å¤åŸ (7ç§’å)
          setTimeout(() => {
            console.log('é˜¶æ®µ4: å®Œå…¨å¤åŸ');
            // å‡å¼±ç‰¹æ•ˆï¼Œå±•ç¤ºæœ€ç»ˆæ•ˆæœ
            const energyPillar = document.querySelector('#energyPillar');
            if (energyPillar) {
              energyPillar.setAttribute('animation__fadeout', 'property: opacity; to: 0; dur: 2000');
            }
          }, 7000);
        }
        
        // ç›‘å¬æ¨¡å‹åŠ è½½
        const models = document.querySelectorAll('a-gltf-model');
        models.forEach(model => {
          model.addEventListener('model-loaded', function() {
            console.log('æ¨¡å‹åŠ è½½å®Œæˆ:', model.id);
          });
          
          model.addEventListener('model-error', function(event) {
            console.log('æ¨¡å‹åŠ è½½å¤±è´¥:', model.id, '(è¿™æ˜¯å¯é€‰æ¨¡å‹ï¼Œä¸å½±å“ä¸»ä½“åŠŸèƒ½)');
          });
        });
      });
    </script>
  </body>
</html>
